<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Documentação de Processos Internos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF and jsPDF-AutoTable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <!-- Signature Pad for virtual signature -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .form-container {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .form-label {
            color: #4a5568;
        }
        .form-input, .form-textarea, .form-select {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .btn-secondary {
            background-color: #64748b;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        /* Style for the signature pad */
        #signature-pad {
            border: 2px dashed #cbd5e1;
            border-radius: 0.375rem;
            cursor: crosshair;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto max-w-5xl px-4 py-8 sm:py-12">

        <header class="text-center mb-10">
            <div class="flex justify-center items-center mb-4">
                <img src="https://i.postimg.cc/GhYJ40wm/Fj8-Bd-AGWQAAr-Cj-H-removebg-preview.png" alt="Brasão da Instituição" class="h-24" id="logo-image" crossorigin="anonymous" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/4a5568?text=Bras%C3%A3o';">
            </div>
            <h1 class="text-3xl font-bold text-gray-900">Sistema de Documentação de Processos</h1>
            <p class="text-md text-gray-600 mt-1">Uso Exclusivo da Corregedoria</p>
        </header>

        <main class="form-container rounded-lg">
            <form id="reportForm" class="p-6 sm:p-8 space-y-6">

                <!-- Seção de Identificação -->
                <fieldset>
                    <legend class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">1. Dados do Fato e Declarante</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="declarante_nome" class="block text-sm font-medium form-label mb-1">Nome do Declarante</label>
                            <input type="text" id="declarante_nome" name="declarante_nome" class="w-full p-2 rounded-md form-input" required>
                        </div>
                        <div>
                            <label for="declarante_matricula" class="block text-sm font-medium form-label mb-1">Matrícula / ID Funcional do Declarante</label>
                            <input type="text" id="declarante_matricula" name="declarante_matricula" class="w-full p-2 rounded-md form-input" required>
                        </div>
                    </div>
                </fieldset>

                <!-- Seção do Fato -->
                <fieldset>
                    <legend class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">2. Detalhes da Ocorrência</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="data_ocorrido" class="block text-sm font-medium form-label mb-1">Data do Ocorrido</label>
                            <input type="date" id="data_ocorrido" name="data_ocorrido" class="w-full p-2 rounded-md form-input" required>
                        </div>
                        <div>
                            <label for="hora_ocorrido" class="block text-sm font-medium form-label mb-1">Hora Aproximada</label>
                            <input type="time" id="hora_ocorrido" name="hora_ocorrido" class="w-full p-2 rounded-md form-input" required>
                        </div>
                        <div>
                            <label for="natureza_ocorrencia" class="block text-sm font-medium form-label mb-1">Natureza da Ocorrência</label>
                            <select id="natureza_ocorrencia" name="natureza_ocorrencia" class="w-full p-2 rounded-md form-select" required>
                                <option value="" disabled selected>Selecione...</option>
                                <option value="Abuso de Autoridade">Abuso de Autoridade</option>
                                <option value="Assédio Moral">Assédio Moral</option>
                                <option value="Corrupção Passiva">Corrupção Passiva</option>
                                <option value="Corrupção Ativa">Corrupção Ativa</option>
                                <option value="Prevaricação">Prevaricação</option>
                                <option value="Quebra de Hierarquia">Quebra de Hierarquia</option>
                                <option value="Uso Indevido de Viatura/Equipamento">Uso Indevido de Viatura/Equipamento</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="local_ocorrido" class="block text-sm font-medium form-label mb-1">Local do Ocorrido</label>
                        <input type="text" id="local_ocorrido" name="local_ocorrido" class="w-full p-2 rounded-md form-input" placeholder="Ex: Rua Principal, nº 123, Bairro Central" required>
                    </div>
                </fieldset>

                <!-- Seção dos Envolvidos -->
                <fieldset>
                    <legend class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">3. Envolvidos e Testemunhas</legend>
                    <div>
                        <label for="envolvidos_nomes" class="block text-sm font-medium form-label mb-1">Nomes e Matrículas dos Envolvidos</label>
                        <textarea id="envolvidos_nomes" name="envolvidos_nomes" rows="3" class="w-full p-2 rounded-md form-textarea" placeholder="Liste os nomes e matrículas dos agentes envolvidos."></textarea>
                    </div>
                    <div class="mt-4">
                        <label for="testemunhas" class="block text-sm font-medium form-label mb-1">Testemunhas</label>
                        <textarea id="testemunhas" name="testemunhas" rows="3" class="w-full p-2 rounded-md form-textarea" placeholder="Liste nomes e contatos de possíveis testemunhas."></textarea>
                    </div>
                </fieldset>

                <!-- Seção da Descrição -->
                <fieldset>
                    <legend class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">4. Relato e Anexos</legend>
                    <div>
                        <label for="descricao_fato" class="block text-sm font-medium form-label mb-1">Descrição do Fato</label>
                        <textarea id="descricao_fato" name="descricao_fato" rows="8" class="w-full p-2 rounded-md form-textarea" placeholder="Descreva de forma clara, objetiva e cronológica todos os detalhes do ocorrido." required></textarea>
                    </div>
                     <div class="mt-4">
                        <label for="anexos" class="block text-sm font-medium form-label mb-1">Anexos</label>
                        <input type="file" id="anexos" name="anexos" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="text-xs text-gray-500 mt-1">Os nomes dos arquivos serão listados no documento gerado.</p>
                    </div>
                </fieldset>

                <!-- Seção Deliberação da Corregedoria -->
                <fieldset>
                    <legend class="text-xl font-semibold text-red-700 border-b border-red-200 pb-2 mb-4">5. Deliberação e Assinatura</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="correg_processo" class="block text-sm font-medium form-label mb-1">Nº Processo / Sindicância</label>
                            <input type="text" id="correg_processo" name="correg_processo" class="w-full p-2 rounded-md form-input" placeholder="Ex: PAD-001/2025" required>
                        </div>
                        <div>
                            <label for="correg_agente" class="block text-sm font-medium form-label mb-1">Corregedor Responsável</label>
                            <input type="text" id="correg_agente" name="correg_agente" class="w-full p-2 rounded-md form-input" placeholder="Nome completo e matrícula" required>
                        </div>
                        <div>
                            <label for="correg_deliberacao" class="block text-sm font-medium form-label mb-1">Deliberação Final</label>
                            <select id="correg_deliberacao" name="correg_deliberacao" class="w-full p-2 rounded-md form-select" required>
                                <option value="" disabled selected>Selecione...</option>
                                <option value="Procedente">Procedente</option>
                                <option value="Improcedente">Improcedente</option>
                                <option value="Parcialmente Procedente">Parcialmente Procedente</option>
                                <option value="Arquivado">Arquivado</option>
                            </select>
                        </div>
                         <div>
                            <label for="correg_punicao" class="block text-sm font-medium form-label mb-1">Punição Aplicada</label>
                            <select id="correg_punicao" name="correg_punicao" class="w-full p-2 rounded-md form-select">
                                <option value="Nenhuma">Nenhuma</option>
                                <option value="Advertência Verbal">Advertência Verbal</option>
                                <option value="Advertência por Escrito">Advertência por Escrito</option>
                                <option value="Suspensão">Suspensão</option>
                                <option value="Multa">Multa</option>
                                <option value="Exoneração / Desligamento">Exoneração / Desligamento</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="correg_resumo" class="block text-sm font-medium form-label mb-1">Fundamentação da Decisão</label>
                        <textarea id="correg_resumo" name="correg_resumo" rows="4" class="w-full p-2 rounded-md form-textarea" placeholder="Resumo da apuração e base para a deliberação." required></textarea>
                    </div>
                    
                    <!-- Signature Pad Section -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium form-label mb-1">Assinatura do Corregedor</label>
                        <div class="wrapper">
                            <canvas id="signature-pad" class="w-full h-48 bg-gray-50"></canvas>
                        </div>
                        <div class="mt-2">
                            <button type="button" id="clear-signature" class="btn-secondary text-xs font-semibold py-1 px-3 rounded-md">Limpar Assinatura</button>
                        </div>
                    </div>
                </fieldset>

                <!-- Envio -->
                <div class="pt-6 border-t mt-6 flex justify-end">
                    <button type="submit" class="btn-primary font-bold py-2 px-6 rounded-md shadow-sm">
                        Gerar Documento Oficial (PDF)
                    </button>
                </div>
            </form>
        </main>

        <footer class="text-center mt-10">
            <p class="text-xs text-gray-500">
                Sistema de documentação para fins de simulação. O uso de insígnias e nomenclaturas oficiais é regulamentado.
            </p>
        </footer>
    </div>

    <script>
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(249, 250, 251)'
        });

        // Adjust canvas size on window resize
        function resizeCanvas() {
            const ratio =  Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear(); // otherwise isEmpty() might return incorrect value
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();


        document.getElementById('clear-signature').addEventListener('click', function () {
            signaturePad.clear();
        });

        const { jsPDF } = window.jspdf;

        document.getElementById('reportForm').addEventListener('submit', function (event) {
            event.preventDefault();
            
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Gerando documento...';

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            const anexoFiles = document.getElementById('anexos').files;
            const anexoNomes = anexoFiles.length > 0 
                ? Array.from(anexoFiles).map(file => `${file.name} (${(file.size / 1024).toFixed(2)} KB)`).join('; ')
                : "Nenhum anexo enviado.";

            const now = new Date();
            const protocol = `CG-INT-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;

            const doc = new jsPDF();

            const addHeader = (docInstance) => {
                const logo = document.getElementById('logo-image');
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = logo.naturalWidth;
                    canvas.height = logo.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(logo, 0, 0, logo.naturalWidth, logo.naturalHeight);
                    const dataURL = canvas.toDataURL('image/png');
                    docInstance.addImage(dataURL, 'PNG', 15, 12, 25, 25);
                } catch (e) {
                    console.error("Erro ao adicionar imagem:", e);
                    docInstance.text("[Brasão]", 20, 25);
                }
                
                docInstance.setFontSize(14);
                docInstance.setFont('helvetica', 'bold');
                docInstance.text('DOCUMENTO DE PROCESSO INTERNO', docInstance.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                docInstance.setFontSize(10);
                docInstance.setFont('helvetica', 'normal');
                docInstance.text(`Nº Processo: ${data.correg_processo || 'N/A'}`, docInstance.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
                docInstance.text(`Data de Emissão: ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR')}`, docInstance.internal.pageSize.getWidth() / 2, 34, { align: 'center' });
                docInstance.setLineWidth(0.5);
                docInstance.line(10, 45, 200, 45);
            };

            const addFooter = (docInstance) => {
                const pageCount = docInstance.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    docInstance.setPage(i);
                    docInstance.setFontSize(8);
                    docInstance.setTextColor(100);
                    const footerText = 'Documento gerado por sistema eletrônico. A validade está condicionada à assinatura do Corregedor responsável.';
                    docInstance.text(footerText, docInstance.internal.pageSize.getWidth() / 2, docInstance.internal.pageSize.getHeight() - 10, { align: 'center' });
                    docInstance.text(`Página ${i} de ${pageCount}`, 198, docInstance.internal.pageSize.getHeight() - 10, { align: 'right' });
                }
            };

            const tableData = [
                { title: '1. DADOS DO FATO E DECLARANTE', content: '' },
                { title: 'Nome do Declarante', content: data.declarante_nome },
                { title: 'Matrícula / ID do Declarante', content: data.declarante_matricula },
                { title: 'Data do Ocorrido', content: new Date(data.data_ocorrido + 'T00:00:00').toLocaleDateString('pt-BR') },
                { title: 'Hora Aproximada', content: data.hora_ocorrido },
                { title: 'Natureza da Ocorrência', content: data.natureza_ocorrencia },
                { title: 'Local do Ocorrido', content: data.local_ocorrido },
                
                { title: '2. ENVOLVIDOS E TESTEMUNHAS', content: '' },
                { title: 'Nomes e Matrículas dos Envolvidos', content: data.envolvidos_nomes || 'Não informado' },
                { title: 'Testemunhas', content: data.testemunhas || 'Não informado' },

                { title: '3. RELATO E ANEXOS', content: '' },
                { title: 'Descrição do Fato', content: data.descricao_fato },
                { title: 'Arquivos Anexados', content: anexoNomes },

                { title: '4. DELIBERAÇÃO DA CORREGEDORIA', content: '' },
                { title: 'Corregedor Responsável', content: data.correg_agente },
                { title: 'Fundamentação da Decisão', content: data.correg_resumo },
                { title: 'Deliberação Final', content: data.correg_deliberacao },
                { title: 'Punição Aplicada', content: data.correg_punicao },
            ];

            const body = tableData.map(row => {
                if (row.content === '') {
                    const isCorregSection = row.title.includes('DELIBERAÇÃO');
                    return [{ 
                        content: row.title, colSpan: 2, 
                        styles: { 
                            fontStyle: 'bold', 
                            fillColor: isCorregSection ? [252, 211, 211] : [230, 230, 230],
                            textColor: isCorregSection ? [159, 28, 28] : [0,0,0]
                        } 
                    }];
                }
                return [row.title, row.content];
            });
            
            addHeader(doc);

            doc.autoTable({
                startY: 50,
                head: [['CAMPO', 'INFORMAÇÃO']],
                body: body,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 60 }, 1: { cellWidth: 'auto' } },
                didDrawPage: (data) => {
                    if (data.pageNumber > 1) {
                       addHeader(doc);
                    }
                }
            });

            // Add Signature to PDF
            let finalY = doc.lastAutoTable.finalY || 60; // Get Y position after table
            if (!signaturePad.isEmpty()) {
                const signatureImage = signaturePad.toDataURL("image/png");
                const sigY = finalY + 20;
                const sigX = doc.internal.pageSize.getWidth() / 2;
                
                doc.addImage(signatureImage, 'PNG', sigX - 30, sigY - 15, 60, 30);
                doc.setLineWidth(0.5);
                doc.line(sigX - 40, sigY + 20, sigX + 40, sigY + 20); // Signature line
                doc.setFontSize(10);
                doc.text(data.correg_agente, sigX, sigY + 25, { align: 'center' });
                doc.setFont('helvetica', 'bold');
                doc.text('Corregedor Responsável', sigX, sigY + 30, { align: 'center' });
            } else {
                 doc.text("[Assinatura Pendente]", doc.internal.pageSize.getWidth() / 2, finalY + 30, { align: 'center' });
            }

            addFooter(doc);
            
            doc.save(`processo_${data.correg_processo.replace(/[^a-zA-Z0-9]/g, '-')}.pdf`);
            
            submitButton.disabled = false;
            submitButton.textContent = 'Gerar Documento Oficial (PDF)';
        });
    </script>

</body>
</html>
